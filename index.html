<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Ninja Dragon Hunter: Mobile</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- MOBILE OPTIMIZATION CSS --- */
    :root {
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    body { 
      box-sizing: border-box; 
      font-family: 'Poppins', sans-serif; 
      overflow: hidden; /* Mencegah scroll halaman */
      touch-action: none; /* Mencegah pull-to-refresh atau zoom browser */
      user-select: none; /* Mencegah seleksi teks saat tap cepat */
      -webkit-user-select: none;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    /* --- BACKGROUND & JUDUL --- */
    #app {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      padding-bottom: var(--safe-bottom);
    }

    .epic-title {
      font-family: 'Poppins', sans-serif; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
      background: linear-gradient(180deg, #fffbeb 0%, #fbbf24 40%, #d97706 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 0px rgba(180, 83, 9, 1));
      -webkit-text-stroke: 0.5px rgba(255, 255, 255, 0.3);
      font-size: 1.8rem; /* Ukuran font mobile friendly */
    }

    /* --- GRID SYSTEM (Responsive Square) --- */
    .map-frame {
      background-color: #5d4037; border: 4px solid #3e2723; border-radius: 12px; padding: 4px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      width: 95vw; /* Lebar hampir penuh layar HP */
      max-width: 400px; /* Batas maksimal untuk Tablet/PC */
      aspect-ratio: 1 / 1; /* Pastikan selalu kotak */
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #gameGrid {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 1px;
    }

    .grid-cell { position: relative; overflow: hidden; border-radius: 4px; }
    
    /* Terrain Styles */
    .grass-light { background-color: #86efac; }
    .grass-dark { background-color: #4ade80; }
    .cell-wall { background-color: #3f6212 !important; border-bottom: 3px solid #14532d; }
    .cell-boss { background-color: rgba(147, 51, 234, 0.4) !important; border: 2px solid #9333ea; animation: bossPulse 2s infinite; }
    .cell-danger { background-color: rgba(239, 68, 68, 0.3) !important; border: 1px solid #ef4444; }
    .cell-safe { background-color: rgba(251, 191, 36, 0.3) !important; border: 1px dashed #fbbf24; }
    
    @keyframes bossPulse { 0%, 100% { border-color: #9333ea; } 50% { border-color: #ffffff; } }

    /* Character Sizes (Responsive via Clamp/Calc) */
    .char-icon {
      font-size: clamp(1.2rem, 8vw, 2.5rem); /* Skala font dinamis */
      filter: drop-shadow(0 2px 1px rgba(0,0,0,0.3));
      z-index: 10;
    }
    
    .robot { animation: robotBounce 0.5s ease; }
    @keyframes robotBounce { 50% { transform: scale(1.2) translateY(-20%); } }

    /* --- CONTROLS (D-PAD) --- */
    .d-pad-container {
      display: grid;
      grid-template-areas: 
        ". up ."
        "left down right";
      gap: 8px;
      margin-top: 10px;
    }
    
    .control-btn {
      width: 55px; height: 55px; /* Tombol besar untuk jempol */
      border-radius: 12px;
      font-size: 1.5rem;
      font-weight: bold;
      background: #fbbf24; color: #451a03;
      box-shadow: 0 4px 0 #b45309;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.1s;
    }
    .control-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #b45309; }

    /* --- MODALS (Mobile Optimized) --- */
    .win-modal {
      width: 90%; max-width: 380px;
      max-height: 85vh;
      overflow-y: auto; /* Scroll jika konten panjang */
      animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* --- UI ELEMENTS --- */
    .music-btn {
      position: absolute; top: 10px; right: 10px; z-index: 50;
      background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 12px; rounded-full; font-size: 0.75rem;
    }
    
    .scroll-indicator {
      font-size: 1.5rem;
      background: rgba(255,255,255,0.1);
      padding: 4px 8px;
      border-radius: 8px;
    }

    /* Screen Shake */
    .shake-screen { animation: screenShake 0.4s ease; }
    @keyframes screenShake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 75% { transform: translate(5px, -5px); } }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full flex flex-col items-center">
   
   <audio id="bgm" loop>
      <source src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_349d473484.mp3?filename=arcade-game-music-loop-113587.mp3" type="audio/mpeg">
   </audio>
   <button id="musicToggle" class="music-btn">üéµ OFF</button>

   <div class="text-center pt-4 pb-2 px-3 w-full relative z-10 flex flex-col items-center shrink-0">
    <h1 class="epic-title mb-1 leading-none">Desa Mahulu</h1>
    
    <div class="flex items-center justify-between w-full max-w-xs px-2 mb-1">
        <div class="flex gap-2">
            <div class="bg-slate-800 border border-slate-600 px-2 py-1 rounded-lg text-white text-xs font-bold flex items-center gap-1">
                <span>üêâ</span> <span id="dragonCount" class="text-red-400 text-sm">4</span>
            </div>
            <div class="bg-slate-800 border border-slate-600 px-2 py-1 rounded-lg text-white text-xs font-bold flex items-center gap-1">
                <span>‚ù§Ô∏è</span> <span id="livesCount" class="text-green-400 text-sm">2</span>
            </div>
        </div>
        <div id="scrollIndicator" class="scroll-indicator grayscale opacity-30 transition-all">üìú</div>
    </div>
    
    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Swipe atau Tekan Tombol</p>
   </div>
   
   <div class="flex-1 flex flex-col items-center justify-center w-full px-2">
     
     <div class="map-frame" id="touchArea">
        <div id="gameGrid"></div>
     </div>

     <div class="d-pad-container pb-4">
       <button id="upBtn" class="control-btn" style="grid-area: up;">‚Üë</button>
       <button id="leftBtn" class="control-btn" style="grid-area: left;">‚Üê</button>
       <button id="downBtn" class="control-btn" style="grid-area: down;">‚Üì</button>
       <button id="rightBtn" class="control-btn" style="grid-area: right;">‚Üí</button>
     </div>
     
     <button id="resetBtn" class="mb-4 text-xs font-bold text-slate-500 bg-slate-800 px-4 py-2 rounded-full border border-slate-700 active:bg-slate-700">üîÑ Reset Game</button>
   </div>

   <div id="actionContainer" class="fixed bottom-6 left-0 right-0 flex justify-center gap-4 px-4 pointer-events-none z-50">
       <button id="talkBtn" class="hidden pointer-events-auto bg-emerald-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg border-b-4 border-emerald-700 active:border-b-0 active:translate-y-1 animate-bounce">
           üí¨ BICARA
       </button>
       <button id="fightBtn" class="hidden pointer-events-auto bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1 animate-pulse">
           ‚öîÔ∏è SERANG
       </button>
       <button id="bossBtn" class="hidden pointer-events-auto bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1 animate-pulse">
           ‚ò†Ô∏è LAWAN BOSS
       </button>
   </div>

   <div id="fightModal" class="fixed inset-0 items-center justify-center hidden px-4 z-50 bg-black/80 backdrop-blur-sm">
    <div class="win-modal bg-slate-900 border-4 border-slate-500 rounded-2xl p-4 text-center relative" id="fightModalFrame">
     
     <div id="bossHeader" class="hidden flex-col items-center mb-2">
         <div class="text-4xl mb-1">üëø</div>
         <h2 class="text-xl font-black text-purple-400 uppercase">BOSS BATTLE</h2>
         <div class="w-full bg-slate-700 rounded-full h-3 mt-1 relative overflow-hidden">
             <div id="bossHpBar" class="bg-gradient-to-r from-purple-600 to-fuchsia-500 h-full transition-all" style="width: 100%"></div>
         </div>
     </div>

     <div id="normalHeader" class="flex flex-col items-center mb-2">
        <div class="text-4xl mb-1">üêâ</div>
        <h2 class="text-xl font-black text-white">PERTARUNGAN</h2>
     </div>
     
     <div class="bg-slate-800 p-3 rounded-xl mb-3 text-left border border-slate-700 relative">
      <button id="formulaBtn" class="hidden absolute top-2 right-2 bg-amber-500 text-amber-900 text-[10px] font-bold px-2 py-1 rounded shadow">üìú Rumus</button>
      
      <div id="formulaArea" class="hidden bg-amber-100 p-2 rounded mb-2 text-amber-900 text-xs border border-amber-500">
          <strong>Rumus Translasi:</strong><br>A(x, y) + T(a, b) = A'(x+a, y+b)
      </div>

      <p id="questionText" class="text-sm font-bold text-white mb-3 leading-snug"></p>
      <div id="optionsContainer" class="flex flex-col gap-2"></div>
     </div>
     
     <div id="feedbackContainer" class="hidden mb-2 p-2 rounded bg-slate-800">
      <p id="feedbackText" class="text-sm font-bold"></p>
     </div>
     
     <button id="cancelFightBtn" class="text-xs text-slate-400 underline py-2">Kabur</button>
    </div>
   </div>

   <div id="dialogModal" class="fixed inset-0 items-center justify-center hidden px-4 z-50 bg-black/80">
    <div class="win-modal bg-amber-100 border-4 border-amber-400 rounded-2xl p-6 text-center">
     <div class="text-5xl mb-2">üë¥</div>
     <h2 class="text-lg font-black text-amber-900 mb-2">Petuah Kakek</h2>
     <p id="grandpaMessage" class="text-amber-900 text-sm mb-4 font-semibold"></p>
     <button id="closeDialogBtn" class="w-full py-3 bg-amber-600 text-white rounded-xl font-bold shadow">Siap!</button>
    </div>
   </div>

   <div id="itemModal" class="fixed inset-0 items-center justify-center hidden px-4 z-50 bg-black/80">
       <div class="win-modal bg-slate-900 border-4 border-amber-500 rounded-2xl p-6 text-center">
           <div class="text-6xl mb-2 animate-bounce">üìú</div>
           <h2 class="text-xl font-black text-amber-400 mb-2">GULUNGAN RUMUS!</h2>
           <p class="text-white text-sm mb-4">Catatan kuno ditemukan! Gunakan saat bertarung.</p>
           <button id="closeItemBtn" class="w-full py-3 bg-amber-600 text-white rounded-xl font-bold shadow">Ambil!</button>
       </div>
   </div>

   <div id="winModal" class="fixed inset-0 items-center justify-center hidden px-4 z-50 bg-black/90">
    <div class="win-modal bg-slate-900 border-4 border-purple-500 rounded-2xl p-6 text-center">
     <div class="text-6xl mb-4 animate-bounce">üèÜ</div>
     <h2 class="text-2xl font-black text-purple-400 mb-2">MENANG!</h2>
     <p class="text-slate-300 text-sm mb-6">Desa Mahulu aman. Kamu Ninja Sejati!</p>
     <button id="playAgainBtn" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg">Main Lagi</button>
    </div>
   </div>
   
   <div id="gameOverModal" class="fixed inset-0 items-center justify-center hidden px-4 z-50 bg-black/90">
    <div class="win-modal bg-slate-900 border-4 border-red-800 rounded-2xl p-6 text-center">
     <div class="text-6xl mb-4">üíÄ</div>
     <h2 class="text-2xl font-black text-red-500 mb-4">GAME OVER</h2>
     <button id="retryBtn" class="bg-red-700 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg">Coba Lagi</button>
    </div>
   </div>
   
   <div id="confettiContainer" class="fixed inset-0 pointer-events-none z-[60]"></div>
  </div>

  <script>
    // --- AUDIO SYSTEM ---
    const AudioController = {
      ctx: null, bgmPlaying: false,
      init: function() {
        if (!this.ctx) {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          this.ctx = new AudioContext();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
      },
      playBGM: function() {
        const bgm = document.getElementById('bgm'); bgm.volume = 0.3;
        bgm.play().then(() => { this.bgmPlaying = true; document.getElementById('musicToggle').textContent = "üéµ ON"; }).catch(e=>{});
      },
      toggleBGM: function() {
        this.init(); const bgm = document.getElementById('bgm');
        if (this.bgmPlaying) { bgm.pause(); this.bgmPlaying = false; document.getElementById('musicToggle').textContent = "üéµ OFF"; }
        else this.playBGM();
      },
      playTone: function(freq, type, duration, vol=0.1) {
        if (!this.ctx) return;
        const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
        o.type=type; o.frequency.setValueAtTime(freq,this.ctx.currentTime);
        g.gain.setValueAtTime(vol,this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+duration);
        o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+duration);
      },
      sfxStep: function(){ if(!this.ctx)return; const b=this.ctx.createBuffer(1,this.ctx.sampleRate*0.05,this.ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1; const s=this.ctx.createBufferSource(); s.buffer=b; const g=this.ctx.createGain(); g.gain.value=0.1; s.connect(g); g.connect(this.ctx.destination); s.start(); },
      sfxCorrect: function(){ this.playTone(600,'sine',0.1); setTimeout(()=>this.playTone(900,'sine',0.3),100); },
      sfxWrong: function(){ this.playTone(150,'sawtooth',0.2); setTimeout(()=>this.playTone(100,'sawtooth',0.3),150); },
      sfxWin: function(){ this.playTone(400,'square',0.1); setTimeout(()=>this.playTone(600,'square',0.1),200); setTimeout(()=>this.playTone(800,'square',0.5),300); },
      sfxAlert: function(){ this.playTone(400,'triangle',0.1); setTimeout(()=>this.playTone(400,'triangle',0.1),100); },
      sfxItem: function(){ this.playTone(800,'sine',0.1, 0.2); setTimeout(()=>this.playTone(1200,'sine',0.3, 0.2),100); }
    };

    // --- GAME DATA ---
    const translationQuestions = [
      { question: "A(3, 2) ditranslasi T(4, 1). A' = ...", options: ["(7, 3)", "(1, 1)", "(12, 2)", "(7, 2)"], correct: 0 },
      { question: "B(-2, 5) ditranslasi T(3, -2). B' = ...", options: ["(1, 7)", "(1, 3)", "(-5, 3)", "(-5, 7)"], correct: 1 },
      { question: "C(1, 4) menjadi C'(5, 6). T = ...", options: ["(4, 2)", "(6, 10)", "(-4, -2)", "(2, 4)"], correct: 0 },
      { question: "D ditranslasi T(2, 3) jadi D'(5, 5). D = ...", options: ["(7, 8)", "(3, 2)", "(3, 8)", "(2, 2)"], correct: 1 },
      { question: "P(2, 1) + T1(2, 0) + T2(0, 3). P'' = ...", options: ["(2, 4)", "(4, 1)", "(4, 4)", "(0, -2)"], correct: 2 },
      { question: "Geser 3 kanan, 4 bawah. Vektornya?", options: ["(3, 4)", "(-3, 4)", "(3, -4)", "(-3, -4)"], correct: 2 },
      { question: "A(1, 1) ditranslasi T(5, 5). A' = ...", options: ["(5, 5)", "(6, 6)", "(4, 4)", "(1, 5)"], correct: 1 },
      { question: "K(0, 0) jadi K'(-3, 2). Translasinya?", options: ["(3, 2)", "(-3, -2)", "(-3, 2)", "(3, -2)"], correct: 2 },
      { question: "M(-1, -2) ditranslasi T(2, 5). M' = ...", options: ["(1, 3)", "(-3, -7)", "(1, 7)", "(3, 3)"], correct: 0 },
      { question: "Q(4, -1) ditranslasi T(-2, 3). Q' = ...", options: ["(2, -4)", "(6, 2)", "(2, 2)", "(6, -4)"], correct: 2 }
    ];

    let gameState = {
      robotPos: { x: 0, y: 0 }, starPos: { x: 1, y: 1 }, gridSize: 6,
      walls: [], dragons: [], bossDragon: { x: 5, y: 5, hp: 3, maxHp: 3, alive: true },
      scroll: { x: 2, y: 0, collected: false },
      defeatedDragons: 0, showingDialog: false, currentEnemy: null, currentDragonObj: null,
      lives: 2, currentQuestion: null, usedQuestions: []
    };

    function generateLevel() {
      gameState.walls = [{x:3,y:2,e:'üå≥'},{x:2,y:3,e:'ü™®'},{x:3,y:3,e:'üè†'},{x:0,y:3,e:'üèîÔ∏è'},{x:5,y:2,e:'‚õ∞Ô∏è'},{x:2,y:5,e:'üå≥'},{x:4,y:0,e:'ü™®'}];
      gameState.dragons = [{x:3,y:0},{x:5,y:1},{x:0,y:4}];
    }

    // --- CORE FUNCTIONS ---
    function initGame() {
      gameState.robotPos = {x:0,y:0}; gameState.starPos = {x:1,y:1}; gameState.lives = 2;
      gameState.scroll = {x:2,y:0,collected:false}; gameState.bossDragon = {x:5,y:5,hp:3,maxHp:3,alive:true};
      gameState.defeatedDragons = 0; gameState.showingDialog = false; gameState.usedQuestions = [];
      generateLevel();
      updateUI(); renderGrid(); checkInteractions();
    }

    function renderGrid() {
      const grid = document.getElementById('gameGrid'); grid.innerHTML = '';
      for (let y=0; y<gameState.gridSize; y++) {
        for (let x=0; x<gameState.gridSize; x++) {
          const cell = document.createElement('div');
          let cls = ((x+y)%2===0) ? 'grass-dark' : 'grass-light';
          let content = '';
          
          const wall = gameState.walls.find(w=>w.x===x&&w.y===y);
          const drag = gameState.dragons.find(d=>d.x===x&&d.y===y);
          const boss = (gameState.bossDragon.alive && gameState.bossDragon.x===x && gameState.bossDragon.y===y);
          const scr = (!gameState.scroll.collected && gameState.scroll.x===x && gameState.scroll.y===y);

          if(wall) { cls='cell-wall'; content=`<span class="char-icon">${wall.e}</span>`; }
          else if(boss) { cls='cell-boss'; content='<span class="char-icon">üëø</span>'; }
          else if(drag) { cls='cell-danger'; content='<span class="char-icon">üêâ</span>'; }
          else if(scr) { content='<span class="char-icon animate-bounce">üìú</span>'; }
          else if(x===gameState.starPos.x && y===gameState.starPos.y) { cls='cell-safe'; content='<span class="char-icon">üë¥</span>'; }
          
          if(x===gameState.robotPos.x && y===gameState.robotPos.y) content='<span class="char-icon robot">ü•∑</span>';

          cell.className = `grid-cell ${cls} flex items-center justify-center`;
          cell.innerHTML = content;
          grid.appendChild(cell);
        }
      }
    }

    function move(dx, dy) {
      if(gameState.showingDialog) return;
      AudioController.init();
      const nx = gameState.robotPos.x + dx; const ny = gameState.robotPos.y + dy;
      if (nx>=0 && nx<gameState.gridSize && ny>=0 && ny<gameState.gridSize) {
        if (!gameState.walls.some(w=>w.x===nx&&w.y===ny) && 
            !gameState.dragons.some(d=>d.x===nx&&d.y===ny) && 
            !(gameState.bossDragon.alive && gameState.bossDragon.x===nx && gameState.bossDragon.y===ny) &&
            !(gameState.starPos.x===nx && gameState.starPos.y===ny)) {
          gameState.robotPos = {x:nx, y:ny};
          AudioController.sfxStep();
          
          if(!gameState.scroll.collected && nx===gameState.scroll.x && ny===gameState.scroll.y) {
             gameState.scroll.collected = true; AudioController.sfxItem();
             document.getElementById('itemModal').classList.remove('hidden'); gameState.showingDialog = true;
             updateUI();
          }
          renderGrid(); checkInteractions();
        }
      }
    }

    function checkInteractions() {
      const px = gameState.robotPos.x, py = gameState.robotPos.y;
      const isNear = (ox, oy) => (Math.abs(px-ox) + Math.abs(py-oy)) <= 1;
      
      const talkBtn = document.getElementById('talkBtn');
      const fightBtn = document.getElementById('fightBtn');
      const bossBtn = document.getElementById('bossBtn');
      
      talkBtn.classList.add('hidden'); fightBtn.classList.add('hidden'); bossBtn.classList.add('hidden');

      if(isNear(gameState.starPos.x, gameState.starPos.y)) {
         talkBtn.classList.remove('hidden'); AudioController.sfxAlert();
      }
      
      let enemyFound = false;
      for(let d of gameState.dragons) {
        if(isNear(d.x, d.y)) {
           fightBtn.classList.remove('hidden'); gameState.currentEnemy='minion'; gameState.currentDragonObj=d; enemyFound=true; AudioController.sfxAlert(); break; 
        }
      }
      if(!enemyFound && gameState.bossDragon.alive && isNear(gameState.bossDragon.x, gameState.bossDragon.y)) {
          bossBtn.classList.remove('hidden'); gameState.currentEnemy='boss'; AudioController.sfxAlert();
      }
    }

    function updateUI() {
      let dCount = gameState.dragons.length + (gameState.bossDragon.alive ? 1 : 0);
      document.getElementById('dragonCount').textContent = dCount;
      document.getElementById('livesCount').textContent = gameState.lives;
      
      const scr = document.getElementById('scrollIndicator');
      const formBtn = document.getElementById('formulaBtn');
      if(gameState.scroll.collected) { scr.classList.remove('grayscale','opacity-30'); formBtn.classList.remove('hidden'); }
      else { scr.classList.add('grayscale','opacity-30'); formBtn.classList.add('hidden'); }
    }

    // --- FIGHT LOGIC ---
    function startFight() {
      gameState.showingDialog = true;
      document.getElementById('fightModal').classList.remove('hidden');
      document.getElementById('formulaArea').classList.add('hidden');
      document.getElementById('feedbackContainer').classList.add('hidden');
      
      const isBoss = gameState.currentEnemy === 'boss';
      document.getElementById('bossHeader').classList.toggle('hidden', !isBoss);
      document.getElementById('bossHeader').classList.toggle('flex', isBoss);
      document.getElementById('normalHeader').classList.toggle('hidden', isBoss);
      document.getElementById('fightModalFrame').style.borderColor = isBoss ? '#a855f7' : '#64748b';
      if(isBoss) updateBossHP();

      let qPool = translationQuestions.filter((_,i)=>!gameState.usedQuestions.includes(i));
      if(qPool.length===0) { gameState.usedQuestions=[]; qPool=translationQuestions; }
      const qIndex = Math.floor(Math.random()*qPool.length);
      gameState.currentQuestion = qPool[qIndex];
      gameState.usedQuestions.push(translationQuestions.indexOf(gameState.currentQuestion));

      document.getElementById('questionText').textContent = gameState.currentQuestion.question;
      const opts = document.getElementById('optionsContainer'); opts.innerHTML='';
      gameState.currentQuestion.options.forEach((opt,i)=>{
        const b = document.createElement('button');
        b.className = 'w-full text-left bg-slate-700 text-white font-semibold py-3 px-4 rounded-lg active:bg-slate-600 text-sm';
        b.textContent = `${String.fromCharCode(65+i)}. ${opt}`;
        b.onclick = ()=>ans(i);
        opts.appendChild(b);
      });
    }

    function updateBossHP() {
       const pct = (gameState.bossDragon.hp/gameState.bossDragon.maxHp)*100;
       document.getElementById('bossHpBar').style.width = pct+'%';
    }

    function ans(idx) {
       const fb = document.getElementById('feedbackContainer');
       const ft = document.getElementById('feedbackText');
       fb.classList.remove('hidden');
       
       if(idx === gameState.currentQuestion.correct) {
          if(gameState.currentEnemy==='boss') {
              gameState.bossDragon.hp--; updateBossHP();
              if(gameState.bossDragon.hp<=0) {
                 AudioController.sfxWin(); gameState.bossDragon.alive=false;
                 ft.textContent="BOSS KALAH!"; ft.className="text-purple-400 font-bold text-sm";
                 setTimeout(endFight, 1500);
              } else {
                 AudioController.sfxCorrect();
                 ft.textContent=`KENA! Sisa HP: ${gameState.bossDragon.hp}`; ft.className="text-yellow-400 font-bold text-sm";
                 setTimeout(startFight, 1000); // Next round
              }
          } else {
              AudioController.sfxCorrect();
              gameState.dragons = gameState.dragons.filter(d=>d!==gameState.currentDragonObj);
              gameState.defeatedDragons++;
              ft.textContent="MENANG!"; ft.className="text-green-400 font-bold text-sm";
              setTimeout(endFight, 1000);
          }
       } else {
          gameState.lives--; updateUI();
          if(gameState.currentEnemy==='boss') { gameState.bossDragon.hp=3; updateBossHP(); } // Reset boss
          
          if(gameState.lives<=0) {
              AudioController.sfxWrong();
              document.getElementById('fightModal').classList.add('hidden');
              document.getElementById('gameOverModal').classList.remove('hidden');
          } else {
              AudioController.sfxWrong();
              ft.textContent="SALAH! Nyawa -1"; ft.className="text-red-400 font-bold text-sm";
              setTimeout(()=>{ document.getElementById('fightModal').classList.add('hidden'); gameState.showingDialog=false; }, 1000);
          }
       }
    }

    function endFight() {
       document.getElementById('fightModal').classList.add('hidden');
       gameState.showingDialog = false;
       updateUI(); renderGrid(); checkInteractions();
       if(!gameState.bossDragon.alive && gameState.dragons.length===0) {
           document.getElementById('winModal').classList.remove('hidden'); AudioController.sfxWin();
           createConfetti();
       }
    }

    function createConfetti() {
       const c = document.getElementById('confettiContainer');
       for(let i=0;i<30;i++){
           const p=document.createElement('div'); p.textContent=['‚ú®','üéâ','üèÜ'][Math.floor(Math.random()*3)];
           p.className='absolute text-2xl transition-all duration-[1500ms] ease-out';
           p.style.left='50%'; p.style.top='50%';
           c.appendChild(p);
           setTimeout(()=>{
               const angle=Math.random()*Math.PI*2; const dist=150+Math.random()*100;
               p.style.transform=`translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`;
               p.style.opacity='0';
           },10);
           setTimeout(()=>p.remove(),1500);
       }
    }

    // --- INPUT HANDLING (SWIPE & BUTTONS) ---
    // Touch / Swipe
    let touchStartX = 0, touchStartY = 0;
    const touchArea = document.getElementById('touchArea');
    touchArea.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive:false});
    touchArea.addEventListener('touchend', e => {
       const dx = e.changedTouches[0].screenX - touchStartX;
       const dy = e.changedTouches[0].screenY - touchStartY;
       if(Math.abs(dx) > Math.abs(dy)) {
           if(Math.abs(dx)>30) move(dx>0?1:-1, 0);
       } else {
           if(Math.abs(dy)>30) move(0, dy>0?1:-1);
       }
    }, {passive:false});

    // Button Listeners
    document.getElementById('upBtn').onclick = ()=>move(0,-1);
    document.getElementById('downBtn').onclick = ()=>move(0,1);
    document.getElementById('leftBtn').onclick = ()=>move(-1,0);
    document.getElementById('rightBtn').onclick = ()=>move(1,0);
    
    // Action Listeners
    document.getElementById('talkBtn').onclick = () => {
        document.getElementById('grandpaMessage').textContent = (!gameState.bossDragon.alive) ? "Kamu hebat! Desa ini aman sekarang." : "Hati-hati, Raja Naga di pojok sangat kuat! Cari gulungan dulu.";
        document.getElementById('dialogModal').classList.remove('hidden'); gameState.showingDialog = true;
    };
    document.getElementById('fightBtn').onclick = startFight;
    document.getElementById('bossBtn').onclick = startFight;
    document.getElementById('formulaBtn').onclick = () => document.getElementById('formulaArea').classList.toggle('hidden');

    // Close Modals
    document.getElementById('closeDialogBtn').onclick = ()=>{ document.getElementById('dialogModal').classList.add('hidden'); gameState.showingDialog=false; };
    document.getElementById('closeItemBtn').onclick = ()=>{ document.getElementById('itemModal').classList.add('hidden'); gameState.showingDialog=false; };
    document.getElementById('cancelFightBtn').onclick = ()=>{ document.getElementById('fightModal').classList.add('hidden'); gameState.showingDialog=false; };
    
    // System
    document.getElementById('musicToggle').onclick = ()=>AudioController.toggleBGM();
    document.getElementById('resetBtn').onclick = ()=>initGame();
    document.getElementById('retryBtn').onclick = ()=>{ document.getElementById('gameOverModal').classList.add('hidden'); initGame(); };
    document.getElementById('playAgainBtn').onclick = ()=>{ document.getElementById('winModal').classList.add('hidden'); initGame(); };

    initGame();
  </script>
 </body>
</html>
